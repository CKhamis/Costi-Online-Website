<!DOCTYPE html>
<html xml:th="https://www.thymeleaf.org">
<head th:replace="Components :: head('Account')"></head>
<body class="bg-2 text-1">
<div th:replace="Components :: main-navigation"></div>

<div class="container-fluid row px-4 py-5">
    <div class="col-xs-12 col-md-5 col-lg-3">
        <div class="p-3 mb-3 border-box" th:object="${user}">
            <div th:replace="Components :: profilePhoto"></div>
            <h4 class="text-center fw-bold" th:text="|*{firstName} *{lastName}|"></h4>
            <p class="text-center pb-0">Costi Network ID</p>
        </div>
        <div class="p-3 border-box mb-3">
            <h3 class="text-center mb-2">Notifications <span class="badge bg-primary rounded-pill" id="notification-count">?</span></h3>
            <div id="notification-container"></div>
        </div>
    </div>
    <div class="col-lg-9 col-md-7 col-xs-12">
        <div class="p-5 mb-2 border-box">
            <h2>Account Status</h2>
            <hr/>
            <div th:replace="Components :: flash" class="my-2"></div>
            <div class="row" th:object="${user}">
                <div class="mb-5 col-lg-4 col-md-6 col-xs-12">
                    <div class="card text-1 border-box">
                        <div class="card-header fw-bold">üëîAccount Role</div>
                        <div class="card-body">
                            <h5 class="card-title" th:text="|Role: *{role}|">Account Role here</h5>
                            <p class="card-text">User role is unchangeable after account creation. Please see administrator for further details</p>
                        </div>
                    </div>
                </div>
                <div class="mb-5 col-lg-4 col-md-6 col-xs-12">
                    <div th:class="'card text-1 border-box ' + (*{isLocked}? 'bg-danger' : '')">
                        <div class="card-header fw-bold" th:text="(*{isLocked}? '&#128274;' : '&#128275;') + 'Account Lock '">üîëAccount Lock</div>
                        <div class="card-body">
                            <h5 class="card-title" th:text="'Your Account is ' + (*{isLocked}? 'locked!' : 'Unlocked!')">Account lock here</h5>
                            <p class="card-text">Your account will be locked if abnormalities are detected in your account</p>
                        </div>
                    </div>
                </div>
                <div class="mb-5 col-lg-4 col-md-6 col-xs-12">
                    <div th:class="'card text-1 border-box ' + (*{enabled}? '' : 'bg-danger')">
                        <div class="card-header fw-bold" th:text="(*{enabled}? '&#9989;' : '&#9940;') + 'Account Enable '">‚ö†Ô∏èAccount Enable</div>
                        <div class="card-body">
                            <h5 class="card-title" th:text="'Your Account is ' + (*{enabled}? 'enabled!' : 'disabled!')">Account enable here</h5>
                            <p class="card-text">Additional layer of verification for administrator accounts. Not needed for USER role.</p>
                        </div>
                    </div>
                </div>
            </div>

            <form class="mb-5" th:action="@{${action}}" method="post" th:object="${user}">
                <h2>Edit Account Information</h2>
                <hr/>
                <div class="form-row row">
                    <div class="col-md-6 mb-3">
                        <label for="pp">Profile Image Select</label>
                        <select th:field="*{profilePicture}" class="form-control" id="pp">
                            <option value = "0">Airplane</option>
                            <option value = "1">Ball</option>
                            <option value = "2">Beach</option>
                            <option value = "3">Car</option>
                            <option value = "4">Cat</option>
                            <option value = "5">Chess</option>
                            <option value = "6">Dog</option>
                            <option value = "7">Drip</option>
                            <option value = "8">Duck</option>
                            <option value = "9">Fish</option>
                            <option value = "10">Guest</option>
                            <option value = "11">Guitar</option>
                            <option value = "12">Kick</option>
                            <option value = "13">Launch</option>
                            <option value = "14">Flower</option>
                            <option value = "15">Snowflake</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="rol">Website Role</label>
                        <select th:field="*{role}" class="form-control disabledSelect" id="rol" disabled>
                            <option value="" disabled="disabled">Select a role</option>
                            <option value = "ADMIN">Administrator</option>
                            <option value = "USER">User</option>
                        </select>
                    </div>
                </div>
                <div class="form-row row">
                    <div class="col-md-4 mb-3">
                        <label for="fnf">First name</label>
                        <input type="text" class="form-control" id="fnf" th:field="*{firstName}"
                               placeholder="First name" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lnf">Last name</label>
                        <input type="text" class="form-control" id="lnf" th:field="*{lastName}"
                               placeholder="Last name" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="mnf">Email</label>
                        <input type="text" class="form-control" id="mnf" th:field="*{email}" placeholder="email" required>
                    </div>
                </div>
                <div class="form-row row">
                    <div class="col-md-6 mb-3">
                        <label for="fnf">Password</label>
                        <input type="password" class="form-control" id="pass" th:field="*{password}" placeholder="Password">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>

            <h2>Account Event Logs</h2>
            <hr/>

            <div class="px-0 container" id="error-container">
                <table class="table table-sm align-middle table-hover table-dark mt-4">
                    <thead>
                    <tr>
                        <th scope="col">Id</th>
                        <th scope="col">Time</th>
                        <th scope="col">Title</th>
                        <th scope="col">Message</th>
                    </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>
        <p>*Costi Network IDs are not as secure as accounts of other websites. Make sure to use a unique password for this website. Accounts are subject for deletion at any point, as this is an experimental feature. Accounts are unable to be deleted once created unless an admin performs manual database editing. Passwords are encrypted in the server's database and cannot be recovered at this time.</p>
    </div>
</div>

<div th:replace="Components :: footer"></div>
<div th:replace="Components :: JS"></div>
<script>
    // Elements
    let count = document.querySelector("#notification-count");
    let container = document.querySelector("#notification-container");
    let logTable = document.querySelector("#table-body");
    let errorContainer = document.querySelector("#error-container");

    // Data
    let notifications, logs;

    // Fetch
    const logFetch = fetch("/api/account-logs/all");
    const notificationFetch = fetch("/api/notifications/all");

    // fetch
    function refresh(){
        Promise.all([logFetch, notificationFetch])
            .then(responses => {
                const response1 = checkStatus(responses[0]);
                const response2 = checkStatus(responses[1]);

                return Promise.all([response1, response2]);
            })
            .then(data => {
                let logDownload = data[0].json();
                let notificationDownload = data[1].json();

                return Promise.all([logDownload, notificationDownload]);
            })
            .then(data => {
                logs = data[0]; // post data
                notifications = data[1]; // recommendation data
                renderLogs();
                renderNotifications();
            })
            .catch((response)=>{
                console.log(response);
                response.json()  // Parse the JSON error response
                    .then(errorData => {
                        errorContainer.innerHTML = `<img src="/icons/Error.svg" alt="error" width="75" class="mx-auto d-block"><h3 class="text-center fw-bold">${errorData.title}</h3><p class="text-center">${errorData.message}</p>`;
                    })
                    .catch(error => {
                        errorContainer.innerHTML = `<img src="/icons/Error.svg" alt="error" width="75" class="mx-auto d-block"><h3 class="text-center fw-bold">There was an error receiving data from Costi Online Services</h3><p class="text-center">Error message could not be parsed. ${error}</p>`;

                        console.error("Error parsing error response:", error);
                    });
            });
    }

    refresh();
    setInterval(refresh, 30000);

    function deleteNotification(id){
        postData("/api/notifications/delete", id)
            .catch(err => {
                console.log(err);
            })
            .then(refresh);
    }

    // Render
    function renderLogs(){
        let tableContent = ``;
        for(let log of logs){
            tableContent += `
            <tr>
                <td>${log.id}</td>
                <td>${log.dateCreated}</td>
                <td>${log.title}</td>
                <td>${log.body}</td>
            </tr>
            `;
        }
        logTable.innerHTML = tableContent;
    }

    function renderNotifications(){
        count.innerText = notifications.length;
        if(notifications.length > 0){
            let content = ``;
            for(let i = notifications.length-1; i >= 0; i--){
                let notification = notifications[i];

                content += `
                    <div class="alert alert-${notification.notificationType} alert-dismissible fade show" role="alert">
                        <p class="fw-bold d-inline">${notification.title} ‚Ä¢ </p>
                        <p class="d-inline">${notification.timeSinceCreated}</p>
                        <a class="btn-close" onclick="deleteNotification(${notification.id})"></a>
                        <p>${notification.body}</p>
                    </div>
                `;
            }
            container.innerHTML = content;
        }else{
            container.innerHTML = "<p class='text-center'>No Notifications</p>";
        }
    }
</script>
</body>
</html>